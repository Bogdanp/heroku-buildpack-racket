#!/bin/bash

# use better globbing rules
shopt -s dotglob nullglob extglob

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

RACKET_SNAPSHOT=http://www.cs.utah.edu/plt/snapshots/current/installers/racket-current-x86_64-linux-precise.sh

APP_DIR=$BUILD_DIR/app
RACKET_DIR=$BUILD_DIR/racket

cd $BUILD_DIR

echo "-----> Moving application into ‘app’ directory"

mkdir -p $APP_DIR
mv $BUILD_DIR/!(app|Procfile) $APP_DIR/

echo "-----> Building Racket snapshot"
echo "     - Downloading prebuilt installer"

wget $RACKET_SNAPSHOT --progress=bar:force -O $CACHE_DIR/racket-installer.sh
chmod +x $CACHE_DIR/racket-installer.sh

echo "-----> Unpacking Racket installation"

$CACHE_DIR/racket-installer.sh --in-place --dest $RACKET_DIR

PATH=$RACKET_DIR/bin:$PATH

echo "-----> Setting up .profile.d environment"

mkdir .profile.d
echo 'export PATH=$PATH:$HOME/racket/bin' >> .profile.d/setup_environment.sh

echo "-----> Installing application package"

raco pkg install -i --no-setup --deps search-auto -n heroku-racket-app --copy $APP_DIR
raco setup -D
