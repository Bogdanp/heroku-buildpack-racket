#!/bin/bash

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

RACKET_SNAPSHOT=http://www.cs.utah.edu/plt/snapshots/current/installers/racket-current-x86_64-linux-precise.sh

RACKET_DIR=$BUILD_DIR/.heroku-racket-installation/

mkdir -p $RACKET_DIR

echo "-----> Building Racket snapshot"

cd $RACKET_DIR

echo "-----> Downloading prebuilt snapshot"

wget $RACKET_SNAPSHOT --progress=bar:force -O racket-installer.sh
chmod +x racket-installer.sh

echo "-----> Unpacking Racket installation"

./racket-installer.sh --in-place --dest racket

PATH=$RACKET_DIR/racket/bin:$PATH

cd $BUILD_DIR

echo "-----> Setting up .profile.d environment"

mkdir .profile.d
echo 'export PATH=$PATH:$HOME/.heroku-racket-installation/racket/bin' >> .profile.d/setup_environment.sh

echo "-----> Installing application package"

raco pkg install --no-setup --deps search-auto --link $BUILD_DIR
raco setup -Dj 1
